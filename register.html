<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œ - é¢‘é‡å°ç¨‹åºé¢„è§ˆ</title>
    <link rel="stylesheet" href="app.css">
    <link rel="stylesheet" href="register.css">
    <script src="js/auth.js"></script>
    <style>
        /* ç§»åŠ¨ç«¯é€‚é… */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* å®¹å™¨æ ·å¼ */
        .page-container {
            max-width: 414px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 414px) {
            .page-container {
                max-width: 100%;
                box-shadow: none;
            }
        }
    </style>
<style>
  /* æ¥å…¥ç»Ÿä¸€é€šæ åéšè—æ³¨å†Œé¡µåŸå¤´éƒ¨ */
  .register-container .header { display: none !important; }
</style>
</head>
<body>
    <div class="page-container">
        <!-- ç»Ÿä¸€é¡¶éƒ¨å¯¼èˆªæ  -->
        <div id="unified-navbar-container"></div>
        <!-- æ³¨å†Œé¡µé¢å†…å®¹ -->
        <div class="register-container">
            <!-- å¤´éƒ¨å¯¼èˆª -->
            <div class="header">
                <button class="back-btn" onclick="goBack()">
                    <span class="back-icon">â†</span>
                </button>
                <div class="header-title">æ³¨å†Œè´¦å·</div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <form class="register-form" id="registerForm">
                <div class="error-message" id="errorMessage" style="display: none;"></div>
                
                <div class="form-step" id="step1">
                    <div class="step-title">åŸºæœ¬ä¿¡æ¯</div>
                    
                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="tel" id="phone" name="phone" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" required>
                            <span class="input-icon">ğŸ“±</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="text" id="verifyCode" name="verifyCode" class="form-input" placeholder="è¯·è¾“å…¥éªŒè¯ç " required maxlength="6">
                            <span class="input-icon">ğŸ”¢</span>
                            <button type="button" class="verify-btn" onclick="sendVerifyCode()">è·å–éªŒè¯ç </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="password" id="password" name="password" class="form-input" placeholder="è¯·è®¾ç½®å¯†ç ï¼ˆ6-20ä½ï¼‰" required minlength="6" maxlength="20">
                            <span class="input-icon">ğŸ”’</span>
                            <span class="toggle-password" onclick="togglePassword('password')">ğŸ‘ï¸</span>
                        </div>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" placeholder="è¯·ç¡®è®¤å¯†ç " required>
                            <span class="input-icon">ğŸ”’</span>
                            <span class="toggle-password" onclick="togglePassword('confirmPassword')">ğŸ‘ï¸</span>
                        </div>
                    </div>

                    <button type="button" class="next-btn" onclick="nextStep()">
                        <span class="btn-text">ä¸‹ä¸€æ­¥</span>
                        <span class="btn-loading" style="display: none;">éªŒè¯ä¸­...</span>
                    </button>
                </div>

                <div class="form-step" id="step2" style="display: none;">
                    <div class="step-title">ä¸ªäººèµ„æ–™</div>
                    
                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="text" id="nickname" name="nickname" class="form-input" placeholder="è¯·è¾“å…¥æ˜µç§°" required maxlength="20">
                            <span class="input-icon">ğŸ‘¤</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ€§åˆ«</label>
                        <div class="gender-options">
                            <label class="gender-option">
                                <input type="radio" name="gender" value="male">
                                <span class="gender-text">ç”·</span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="female">
                                <span class="gender-text">å¥³</span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="other">
                                <span class="gender-text">å…¶ä»–</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="date" id="birthday" name="birthday" class="form-input">
                            <span class="input-icon">ğŸ‚</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input type="text" id="city" name="city" class="form-input" placeholder="è¯·é€‰æ‹©æ‰€åœ¨åŸå¸‚" maxlength="50">
                            <span class="input-icon">ğŸ“</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="prev-btn" onclick="prevStep()">ä¸Šä¸€æ­¥</button>
                        <button type="submit" class="register-btn">
                            <span class="btn-text">å®Œæˆæ³¨å†Œ</span>
                            <span class="btn-loading" style="display: none;">æ³¨å†Œä¸­...</span>
                        </button>
                    </div>
                </div>

                <!-- ç”¨æˆ·åè®® -->
                <div class="agreement">
                    <label class="agreement-checkbox">
                        <input type="checkbox" id="agreement" name="agreement" required>
                        <span class="checkmark"></span>
                        æˆ‘å·²é˜…è¯»å¹¶åŒæ„
                        <a href="#" class="agreement-link">ã€Šç”¨æˆ·åè®®ã€‹</a>
                        å’Œ
                        <a href="#" class="agreement-link">ã€Šéšç§æ”¿ç­–ã€‹</a>
                    </label>
                </div>

                <!-- ç™»å½•é“¾æ¥ -->
                <div class="login-link">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="login.html">ç«‹å³ç™»å½•</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let verifyCodeTimer = null;
        let verifyCodeCount = 60;

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            if (currentStep > 1) {
                prevStep();
            } else {
                window.history.back();
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // æ£€æŸ¥å¯†ç å¼ºåº¦
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            let strength = 0;
            let text = '';
            let className = '';

            if (password.length >= 6) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            switch (strength) {
                case 0:
                case 1:
                    text = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                    className = 'weak';
                    break;
                case 2:
                case 3:
                    text = 'å¯†ç å¼ºåº¦ï¼šä¸­';
                    className = 'medium';
                    break;
                case 4:
                case 5:
                    text = 'å¯†ç å¼ºåº¦ï¼šå¼º';
                    className = 'strong';
                    break;
            }

            strengthDiv.textContent = text;
            strengthDiv.className = `password-strength ${className}`;
        }

        // ä¸‹ä¸€æ­¥
        function nextStep() {
            if (validateStep1()) {
                currentStep = 2;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            }
        }

        // ä¸Šä¸€æ­¥
        function prevStep() {
            currentStep = 1;
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
        }

        // éªŒè¯ç¬¬ä¸€æ­¥è¡¨å•
        function validateStep1() {
            const phone = document.getElementById('phone').value;
            const verifyCode = document.getElementById('verifyCode').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showError('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return false;
            }

            if (!verifyCode || verifyCode.length !== 6) {
                showError('è¯·è¾“å…¥6ä½éªŒè¯ç ');
                return false;
            }

            if (!password || password.length < 6 || password.length > 20) {
                showError('å¯†ç é•¿åº¦åº”ä¸º6-20ä½');
                return false;
            }

            if (password !== confirmPassword) {
                showError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return false;
            }

            return true;
        }

        // å‘é€éªŒè¯ç 
        function sendVerifyCode() {
            const phone = document.getElementById('phone').value;
            const btn = document.querySelector('.verify-btn');

            if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                showError('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                return;
            }

            // å¼€å§‹å€’è®¡æ—¶
            btn.disabled = true;
            verifyCodeCount = 60;
            verifyCodeTimer = setInterval(() => {
                verifyCodeCount--;
                btn.textContent = `${verifyCodeCount}såé‡å‘`;
                
                if (verifyCodeCount <= 0) {
                    clearInterval(verifyCodeTimer);
                    btn.disabled = false;
                    btn.textContent = 'è·å–éªŒè¯ç ';
                }
            }, 1000);

            // æ¨¡æ‹Ÿå‘é€éªŒè¯ç 
            console.log('å‘é€éªŒè¯ç åˆ°:', phone);
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„API
            setTimeout(() => {
                showError('éªŒè¯ç å·²å‘é€ï¼Œè¯·æ³¨æ„æŸ¥æ”¶ï¼ˆæµ‹è¯•éªŒè¯ç ï¼š123456ï¼‰');
            }, 500);
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleBtn = passwordInput.parentNode.querySelector('.toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸';
            }
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const agreement = document.getElementById('agreement').checked;
            
            if (!agreement) {
                showError('è¯·å…ˆåŒæ„ç”¨æˆ·åè®®å’Œéšç§æ”¿ç­–');
                return;
            }

            const formData = {
                phone: document.getElementById('phone').value,
                verifyCode: document.getElementById('verifyCode').value,
                password: document.getElementById('password').value,
                nickname: document.getElementById('nickname').value,
                gender: document.querySelector('input[name="gender"]:checked')?.value,
                birthday: document.getElementById('birthday').value,
                city: document.getElementById('city').value
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const registerBtn = document.querySelector('.register-btn');
            const btnText = registerBtn.querySelector('.btn-text');
            const btnLoading = registerBtn.querySelector('.btn-loading');
            
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            registerBtn.disabled = true;

            // è°ƒç”¨AuthManagerçš„æ³¨å†Œæ–¹æ³•
            if (window.authManager) {
                window.authManager.register(formData).then(success => {
                    if (success) {
                        // æ³¨å†ŒæˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ
                        window.location.href = 'home-main-page.html';
                    } else {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        btnText.style.display = 'inline';
                        btnLoading.style.display = 'none';
                        registerBtn.disabled = false;
                    }
                });
            }
        });

        // ç›‘å¬å¯†ç è¾“å…¥ï¼Œå®æ—¶æ˜¾ç¤ºå¼ºåº¦
        document.getElementById('password').addEventListener('input', function(e) {
            checkPasswordStrength(e.target.value);
        });

        // åŠ è½½ç»Ÿä¸€å¯¼èˆªæ 
        function loadUnifiedNavbar() {
            fetch('components/unified-navbar.html')
                .then(resp => resp.text())
                .then(html => {
                    const container = document.getElementById('unified-navbar-container');
                    if (container) container.innerHTML = html;
                })
                .catch(err => console.error('åŠ è½½ç»Ÿä¸€é¡¶éƒ¨æ å¤±è´¥:', err));
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadUnifiedNavbar();
            // ç­‰å¾…authManageråˆå§‹åŒ–
            setTimeout(() => {
                if (window.authManager && window.authManager.isLoggedIn) {
                    window.location.href = 'home-main-page.html';
                }
            }, 100);

            // è®¾ç½®é»˜è®¤ç”Ÿæ—¥ä¸º18å²
            const today = new Date();
            const defaultBirthday = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            document.getElementById('birthday').value = defaultBirthday.toISOString().split('T')[0];
        });
    </script>
</body>
</html>