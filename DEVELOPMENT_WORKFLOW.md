# 小程序开发同步工作流程

## 概述

本文档定义了品遇小程序开发过程中，如何保持HTML预览与微信开发者工具同步预览测试的标准工作流程。

## 🎯 目标

- 实现小程序代码与HTML预览的实时同步
- 提供双端一致的开发体验
- 减少代码维护成本
- 提高开发效率

## 🛠️ 工具准备

### 必需工具
- **微信开发者工具**: 小程序开发和调试
- **现代浏览器**: HTML预览测试
- **Node.js**: 运行同步脚本
- **VS Code**: 代码编辑（推荐）

### 项目工具
- `sync-dev.js`: 自动同步脚本
- `web-converter/`: WXML/WXSS转换工具
- `server.py`: 本地预览服务器

## 📋 开发工作流程

### 1. 环境启动

```bash
# 启动本地预览服务器
python3 server.py 8081

# 启动文件监听（可选）
node sync-dev.js watch
```

### 2. 功能开发流程

#### 2.1 新功能开发
```
1. 在微信开发者工具中开发功能
   ├── 创建/修改 .wxml 文件
   ├── 创建/修改 .wxss 文件
   ├── 创建/修改 .js 文件
   └── 创建/修改 .json 文件

2. 微信开发者工具测试
   ├── 编译预览
   ├── 功能测试
   └── 样式调整

3. 同步到HTML预览
   ├── 运行: node sync-dev.js sync [页面名]
   ├── 浏览器预览: http://localhost:8081
   └── 对比测试结果

4. 双端验证
   ├── 微信开发者工具最终测试
   ├── 浏览器预览最终测试
   └── 确认一致性
```

#### 2.2 现有功能修改
```
1. 在微信开发者工具中修改
2. 立即同步: node sync-dev.js sync [页面名]
3. 双端对比测试
4. 如有差异，调整映射配置
```

### 3. 页面开发检查清单

#### 开发前检查
- [ ] 确认页面在 `sync-dev.js` 配置中
- [ ] 检查依赖的组件是否已同步
- [ ] 确认资源文件路径映射

#### 开发中检查
- [ ] 每完成一个功能模块立即同步
- [ ] 使用标准的小程序组件和API
- [ ] 避免使用平台特有的高级功能

#### 开发后检查
- [ ] 微信开发者工具功能测试通过
- [ ] HTML预览功能测试通过
- [ ] 样式在两端显示一致
- [ ] 交互逻辑在两端表现一致

## 🔧 同步脚本使用

### 基本命令

```bash
# 同步所有页面
node sync-dev.js sync

# 同步指定页面
node sync-dev.js sync home
node sync-dev.js sync frequency-match

# 启动文件监听
node sync-dev.js watch
```

### 配置说明

在 `sync-dev.js` 中配置需要同步的页面：

```javascript
this.config = {
  // 需要同步的页面
  syncPages: ['home', 'frequency-match', 'profile', 'messages'],
  
  // 资源映射
  resourceMapping: {
    localImages: {
      '/assets/images/logo.png': 'https://example.com/logo.png'
    }
  }
}
```

## 📱 双端测试策略

### 微信开发者工具测试
- **功能测试**: 所有交互功能正常
- **API测试**: 小程序API调用正常
- **性能测试**: 页面加载和响应速度
- **兼容性测试**: 不同机型适配

### HTML预览测试
- **布局测试**: 页面布局与小程序一致
- **样式测试**: 颜色、字体、间距等视觉效果
- **响应式测试**: 不同屏幕尺寸适配
- **交互测试**: 基础交互功能模拟

### 差异处理
当发现两端不一致时：

1. **样式差异**
   - 检查rpx单位转换
   - 确认CSS兼容性
   - 调整转换器配置

2. **功能差异**
   - 检查API桥接层
   - 完善模拟数据
   - 更新转换逻辑

3. **布局差异**
   - 检查组件转换映射
   - 确认HTML结构
   - 调整CSS样式

## 🎨 样式同步注意事项

### rpx单位处理
- 小程序使用rpx，HTML使用px
- 转换比例：1rpx = 0.5px (基于375px宽度)
- 自动转换在 `wxss-to-css.js` 中处理

### 组件样式
- 使用全局样式变量保持一致性
- 组件样式独立，避免相互影响
- 注意小程序组件的默认样式

### 响应式设计
- 优先适配375px宽度（iPhone 6/7/8）
- 使用相对单位确保缩放适配
- 测试不同设备尺寸

## 🔗 API桥接处理

### 小程序API映射
```javascript
// 在HTML预览中模拟小程序API
const wx = {
  navigateTo: (options) => {
    // 模拟页面跳转
    window.location.href = options.url.replace('/pages/', '') + '.html'
  },
  
  showToast: (options) => {
    // 模拟提示框
    alert(options.title)
  },
  
  request: (options) => {
    // 模拟网络请求
    fetch(options.url, {
      method: options.method || 'GET',
      data: options.data
    }).then(response => response.json())
      .then(data => options.success && options.success({data}))
      .catch(error => options.fail && options.fail(error))
  }
}
```

### 数据模拟
- 为HTML预览提供模拟数据
- 保持数据结构与小程序一致
- 模拟异步数据加载

## 📊 资源管理

### 图片资源
- **小程序**: 使用本地图片或网络图片
- **HTML预览**: 统一使用网络图片
- **映射配置**: 在同步脚本中配置路径映射

### 字体资源
- 使用系统字体确保兼容性
- 避免使用小程序特有字体
- 测试字体在不同平台的显示效果

## 🚀 自动化优化

### 文件监听
启用文件监听后，修改文件会自动触发同步：

```bash
node sync-dev.js watch
```

监听范围：
- `pages/**/*.{wxml,wxss,js,json}`
- `components/**/*.{wxml,wxss,js,json}`
- `app.{wxss,js,json}`

### 热重载
- 配合本地服务器实现热重载
- 修改文件后自动刷新预览
- 提高开发效率

## 🐛 常见问题解决

### 同步失败
1. 检查文件路径是否正确
2. 确认Node.js环境正常
3. 查看控制台错误信息
4. 检查文件权限

### 样式不一致
1. 检查rpx转换是否正确
2. 确认CSS选择器优先级
3. 检查浏览器兼容性
4. 对比生成的CSS文件

### 功能异常
1. 检查API桥接层实现
2. 确认模拟数据正确性
3. 查看浏览器控制台错误
4. 对比小程序和HTML的JavaScript逻辑

## 📈 性能优化

### 同步性能
- 只同步必要的页面
- 使用增量同步减少处理时间
- 缓存转换结果

### 预览性能
- 压缩生成的CSS和HTML
- 优化图片资源大小
- 使用CDN加速资源加载

## 🔄 版本控制

### Git工作流
```bash
# 开发分支
git checkout -b feature/new-page

# 开发完成后同步
node sync-dev.js sync

# 提交代码（包含同步后的HTML文件）
git add .
git commit -m "feat: 新增页面功能"

# 合并到主分支
git checkout main
git merge feature/new-page
```

### 文件管理
- 小程序源码：版本控制
- 生成的HTML/CSS：可选择性提交
- 配置文件：必须版本控制

## 📚 最佳实践

### 开发习惯
1. **小步快跑**: 频繁同步，及时发现问题
2. **双端验证**: 每个功能都要在两端测试
3. **文档更新**: 及时更新配置和文档
4. **代码规范**: 遵循项目代码规范

### 团队协作
1. **统一工具**: 团队使用相同的开发工具链
2. **共享配置**: 同步脚本配置统一管理
3. **问题记录**: 记录常见问题和解决方案
4. **知识分享**: 定期分享开发经验

## 🎯 总结

通过遵循本工作流程，可以实现：
- ✅ 小程序与HTML预览的高度一致性
- ✅ 高效的开发和测试流程
- ✅ 减少维护成本和开发时间
- ✅ 提供良好的开发体验

记住：**边开发边同步，保持双端一致**是关键原则！